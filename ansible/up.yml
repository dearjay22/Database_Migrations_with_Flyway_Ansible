---
- name: Assignment 4 - Bring environment up and run initial migrations
  hosts: localhost
  connection: local
  vars:
    mysql_root_password: "rootpass"
    db_name: "subscriptions"
    db_user: "sub_user"
    db_pass: "sub_pass"
    mysql_host: "127.0.0.1"
    mysql_port: 3306

  tasks:
    - name: Ensure MySQL container is running
      community.docker.docker_container:
        name: a4-mysql
        image: mysql:8
        state: started
        restart_policy: unless-stopped
        env:
          MYSQL_ROOT_PASSWORD: "{{ mysql_root_password }}"
          MYSQL_DATABASE: "{{ db_name }}"
        ports:
          - "{{ mysql_port }}:3306"

    - name: Wait for MySQL port
      wait_for:
        host: "{{ mysql_host }}"
        port: "{{ mysql_port }}"
        delay: 5
        timeout: 60

    - name: Ensure DB user exists
      community.mysql.mysql_user:
        login_user: root
        login_password: "{{ mysql_root_password }}"
        name: "{{ db_user }}"
        password: "{{ db_pass }}"
        host: "%"
        priv: "{{ db_name }}.*:ALL"
        state: present

    - name: Run initial Flyway migrations (Docker)
      ansible.builtin.shell: |
        docker run --rm --network host \
          -v {{ playbook_dir }}/../flyway:/flyway/sql \
          flyway/flyway:10 \
          -url=jdbc:mysql://{{ mysql_host }}:{{ mysql_port }}/{{ db_name }} \
          -user={{ db_user }} -password={{ db_pass }} \
          -locations=filesystem:/flyway/migrations_initial migrate
      args:
        chdir: "{{ playbook_dir }}/.."
